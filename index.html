<!doctype html>
<html lang="fa" dir="rtl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>کانفیگ‌های V2Ray – IRAN.AZAD</title>

<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:"Vazirmatn",sans-serif}
body{
  min-height:100vh;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#eee;
  padding:2rem 1rem;
  display:flex;flex-direction:column;align-items:center
}

/* ——— هدر ——— */
header{
  display:flex;
  flex-direction:column;
  align-items:center;
  margin-bottom:2rem;
}
.logo{
  width:255px;
  display:block;
  margin-bottom:1.2rem;
}
/* گروه دکمه‌ها */
.btn-group{
  display:flex;
  gap:.8rem;
  flex-wrap:wrap;            /* در موبایل اگر جا نشد، می‌شکند */
  margin-bottom:1.2rem;
}
.btn-download{
  font-size: .65rem;            /* کوچک‌تر از حالت پیش‌فرض (۱rem) */
  padding: .45rem .9rem;        /* قبلاً .7rem 1.4rem بود → ×0.65 */
  background:linear-gradient(90deg,#00c9ff 0%,#92fe9d 100%);
  color:#04252e;
  border:none;border-radius:8px;
  font-weight:700;text-decoration:none;
  transition:filter .2s
}

}
.btn-download:hover{filter:brightness(1.08)}

h1{
  font-size:clamp(1.4rem,4vw,2.2rem);
  margin-top:.6rem;
  text-align:center
}
/* تاریخ */
#datetime{font-size:.8rem;margin-top:.4rem;opacity:.85}

/* متن به‌روزرسانی */
#last-update{
  font-size:.7rem;
  margin-top:.3rem;
  opacity:.7;
  color:#92fe9d;
  text-align:center
}

/* ——— جعبه کانفیگ‌ها ——— */
#box{
  background:#ffffff0d;border:1px solid #ffffff22;
  border-radius:12px;width:100%;max-width:900px;
  padding:1rem;overflow:auto
}
.config-item{
  display:flex;gap:.5rem;align-items:center;
  background:#ffffff12;border:1px solid #ffffff22;
  border-radius:6px;margin-bottom:.6rem;
  padding:.5rem .75rem;direction:ltr;word-break:break-all
}
.config-text{flex:1;font-size:.85rem;line-height:1.4}
.copy-btn{
  padding:.4rem .8rem;border:none;border-radius:4px;
  background:#00c9ff;color:#04252e;font-size:.8rem;font-weight:700;
  cursor:pointer;transition:filter .2s
}
.copy-btn:hover{filter:brightness(1.1)}

footer{margin-top:1.5rem;font-size:.75rem;opacity:.7;text-align:center}

@media(max-width:480px){
  .logo{width:195px}
  .config-text{font-size:.78rem}
  .copy-btn{padding:.3rem .6rem;font-size:.75rem}
}

/* اضافه کردن به بخش استایل */
.utility-btn {
  font-size: 0.65rem;
  padding: 0.45rem 0.9rem;
  background: linear-gradient(90deg, #00c9ff 0%, #92fe9d 100%);
  color: #04252e;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  text-decoration: none;
  transition: filter 0.2s;
  cursor: pointer;
  margin-right: 0.5rem;
}
.utility-btn:hover {
  filter: brightness(1.08);
}
.utility-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.ping-indicator {
  font-size: 0.7rem;
  color: #92fe9d;
  margin-left: 0.5rem;
  min-width: 50px;
  text-align: right;
}
</style>

<body>

<header>
  <!-- لوگو -->
  <img src="iran_azad_logo.gif.png" alt="IRAN AZAD logo" class="logo">

  <!-- گروه دکمه‌های دانلود -->
  <div class="btn-group">
    <a class="btn-download" href="https://v2rayn.2dust.link/v2rayN-windows-64-SelfContained.zip" target="_blank" rel="noopener">دانلود ویندوز</a>
    <a class="btn-download" href="https://v2rayng.2dust.link/v2rayNG_1.10.4_arm64-v8a.apk" target="_blank" rel="noopener">دانلود اندروید</a>
    <a class="btn-download" href="https://apps.apple.com/ca/app/shadowrocket/id932747118" target="_blank" rel="noopener noreferrer">دانلود آیفون</a>
  </div>

  <h1>جدیدترین کانفیگ‌های&nbsp;V2Ray</h1>
  <div id="datetime">در حال به‌روزرسانی…</div>
  <div id="last-update">در حال بررسی آخرین به‌روزرسانی…</div>
</header>

<div class="utility-buttons" style="margin-bottom: 1rem; display: flex; justify-content: center;">
  <button id="copy-all" class="utility-btn">کپی کل کانفیگ‌ها</button>
  <button id="test-speed" class="utility-btn">تست سرعت و مرتب‌سازی</button>
</div>

<div id="box"><div id="loading">در حال بارگیری…</div></div>

<footer> به‌روزرسانی توسط  <strong>© 2025 IRAN.AZAD </strong></footer>

<script>
/* ---------- بارگذاری کانفیگ‌ها ---------- */
// متغیر برای نگهداری متن کامل کانفیگ‌ها
let allConfigsText = '';

// تابع استخراج دامنه از کانفیگ
function extractDomain(configText) {
  try {
    // برای لینک‌های VLESS
    if (configText.includes('vless://')) {
      const match = configText.match(/@([^:]+):/);
      return match ? match[1] : null;
    }
    // برای لینک‌های VMess
    else if (configText.includes('vmess://')) {
      // اگر Base64 است
      const match = configText.match(/@([^:]+):/);
      if (match) return match[1];
      
      // تلاش برای دیکد Base64 ساده (بدون پارس کامل JSON)
      try {
        const decoded = atob(configText.replace('vmess://', ''));
        const simpleMatch = decoded.match(/"add":"([^"]+)"/);
        return simpleMatch ? simpleMatch[1] : null;
      } catch (e) {
        return null;
      }
    }
  } catch (e) {
    console.error('خطا در استخراج دامنه:', e);
  }
  return null;
}

// تابع تست سرعت با استفاده از بارگذاری تصویر
function testDomainSpeed(domain) {
  return new Promise((resolve) => {
    if (!domain) {
      resolve(Infinity);
      return;
    }
    
    const startTime = Date.now();
    const img = new Image();
    
    img.onload = () => {
      const pingTime = Date.now() - startTime;
      resolve(pingTime);
    };
    
    img.onerror = () => {
      const pingTime = Date.now() - startTime;
      // اگر خطا داد ولی سریع بود، احتمالاً سرور فعال است
      resolve(pingTime < 1000 ? pingTime : Infinity);
    };
    
    // تلاش برای بارگذاری favicon از دامنه
    img.src = `https://${domain}/favicon.ico?t=${Date.now()}`;
    
    // تایم‌اوت بعد از 3 ثانیه
    setTimeout(() => resolve(Infinity), 3000);
  });
}

// تابع کپی کردن تمام کانفیگ‌ها
function copyAllConfigs() {
  const copyBtn = document.getElementById('copy-all');
  const originalText = copyBtn.textContent;
  
  navigator.clipboard.writeText(allConfigsText).then(() => {
    copyBtn.textContent = 'تمام کانفیگ‌ها کپی شد!';
    setTimeout(() => {
      copyBtn.textContent = originalText;
    }, 1500);
  }).catch(err => {
    copyBtn.textContent = 'خطا در کپی!';
    setTimeout(() => {
      copyBtn.textContent = originalText;
    }, 1500);
  });
}

// تابع تست سرعت و مرتب‌سازی
async function testSpeedAndSort() {
  const testBtn = document.getElementById('test-speed');
  testBtn.disabled = true;
  testBtn.textContent = 'در حال تست...';
  
  const configItems = document.querySelectorAll('.config-item');
  const results = [];
  
  // تست همه کانفیگ‌ها
  for (let i = 0; i < configItems.length; i++) {
    const item = configItems[i];
    const configText = item.querySelector('.config-text').textContent;
    const domain = extractDomain(configText);
    
    // اضافه کردن نشانگر پینگ اگر وجود ندارد
    let pingIndicator = item.querySelector('.ping-indicator');
    if (!pingIndicator) {
      pingIndicator = document.createElement('span');
      pingIndicator.className = 'ping-indicator';
      item.insertBefore(pingIndicator, item.querySelector('.copy-btn'));
    }
    
    pingIndicator.textContent = 'در حال تست...';
    
    // تست سرعت
    const ping = await testDomainSpeed(domain);
    
    // نمایش نتیجه
    if (ping === Infinity) {
      pingIndicator.textContent = '∞ ms';
    } else {
      pingIndicator.textContent = `${ping} ms`;
    }
    
    results.push({ item, ping });
  }
  
  // مرتب‌سازی بر اساس پینگ
  results.sort((a, b) => a.ping - b.ping);
  
  // بازسازی DOM
  const box = document.getElementById('box');
  box.innerHTML = '';
  results.forEach(result => {
    box.appendChild(result.item);
  });
  
  testBtn.disabled = false;
  testBtn.textContent = 'تست سرعت و مرتب‌سازی';
}

// به‌روزرسانی تابع fetch برای ذخیره متن کامل کانفیگ‌ها
// این بخش را جایگزین کنید یا تغییر دهید
fetch('configs.txt')
  .then(r => r.text())
  .then(text => {
    allConfigsText = text; // ذخیره متن کامل
    const box = document.getElementById('box');
    box.innerHTML = '';
    const lines = text.trim().split(/\r?\n/).filter(Boolean);
    if (!lines.length) {
      box.textContent = 'فایلی یافت نشد';
      return;
    }
    
    lines.forEach(line => {
      const item = document.createElement('div');
      item.className = 'config-item';
      
      const span = document.createElement('span');
      span.className = 'config-text';
      span.textContent = line;
      
      const btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.textContent = 'Copy';
      btn.onclick = () => {
        navigator.clipboard.writeText(line).then(() => {
          const prev = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => btn.textContent = prev, 1500);
        });
      };
      
      item.append(span, btn);
      box.appendChild(item);
    });
    
    // فعال کردن دکمه‌های جدید
    document.getElementById('copy-all').onclick = copyAllConfigs;
    document.getElementById('test-speed').onclick = testSpeedAndSort;
    
    // بررسی آخرین به‌روزرسانی فایل
    checkLastUpdate();
  })
  .catch(() => document.getElementById('box').textContent = 'خطا در بارگیری فایل');

/* ---------- بررسی آخرین به‌روزرسانی ---------- */
function checkLastUpdate(){
  fetch('configs.txt', {method: 'HEAD'})
    .then(response => {
      const lastModified = response.headers.get('Last-Modified');
      if(lastModified){
        const fileDate = new Date(lastModified);
        const now = new Date();
        const diffMs = now - fileDate;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffHours / 24);
        
        let updateText = '';
        if(diffDays > 0){
          updateText = `به‌روزرسانی شده ${diffDays} روز قبل`;
        } else if(diffHours > 0){
          updateText = `به‌روزرسانی شده ${diffHours} ساعت قبل`;
        } else {
          const diffMinutes = Math.floor(diffMs / (1000 * 60));
          if(diffMinutes > 0){
            updateText = `به‌روزرسانی شده ${diffMinutes} دقیقه قبل`;
          } else {
            updateText = 'به‌روزرسانی شده همین الان';
          }
        }
        
        document.getElementById('last-update').textContent = updateText;
      } else {
        document.getElementById('last-update').textContent = 'زمان به‌روزرسانی نامشخص';
      }
    })
    .catch(() => {
      document.getElementById('last-update').textContent = 'خطا در بررسی زمان به‌روزرسانی';
    });
}

/* ---------- تاریخ و ساعت شمسی ---------- */
function updateDateTime(){
  const now=new Date();
  const opts={calendar:'persian',numberingSystem:'latn',
              hour:'2-digit',minute:'2-digit',second:'2-digit',
              weekday:'long',year:'numeric',month:'long',day:'numeric',
              timeZone:'Asia/Tehran'};
  document.getElementById('datetime').textContent=
    new Intl.DateTimeFormat('fa-IR-u-ca-persian',opts).format(now);
}
updateDateTime(); setInterval(updateDateTime,30000);
</script>

</body>
</html>
