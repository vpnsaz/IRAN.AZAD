<!doctype html>
<html lang="fa" dir="rtl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>کانفیگ‌های V2Ray – IRAN.AZAD</title>

<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:"Vazirmatn",sans-serif}
body{
  min-height:100vh;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#eee;
  padding:2rem 1rem;
  display:flex;flex-direction:column;align-items:center
}

/* ——— هدر ——— */
header{
  display:flex;
  flex-direction:column;
  align-items:center;
  margin-bottom:2rem;
}
.logo{
  width:255px;
  display:block;
  margin-bottom:1.2rem;
}
/* گروه دکمه‌ها */
.btn-group{
  display:flex;
  gap:.8rem;
  flex-wrap:wrap;            /* در موبایل اگر جا نشد، می‌شکند */
  margin-bottom:1.2rem;
}
.btn-download{
  font-size: .65rem;            /* کوچک‌تر از حالت پیش‌فرض (۱rem) */
  padding: .45rem .9rem;        /* قبلاً .7rem 1.4rem بود → ×0.65 */
  background:linear-gradient(90deg,#00c9ff 0%,#92fe9d 100%);
  color:#04252e;
  border:none;border-radius:8px;
  font-weight:700;text-decoration:none;
  transition:filter .2s
}

}
.btn-download:hover{filter:brightness(1.08)}

h1{
  font-size:clamp(1.4rem,4vw,2.2rem);
  margin-top:.6rem;
  text-align:center
}
/* تاریخ */
#datetime{font-size:.8rem;margin-top:.4rem;opacity:.85}

/* متن به‌روزرسانی */
#last-update{
  font-size:.7rem;
  margin-top:.3rem;
  opacity:.7;
  color:#92fe9d;
  text-align:center
}

/* ——— جعبه کانفیگ‌ها ——— */
#box{
  background:#ffffff0d;border:1px solid #ffffff22;
  border-radius:12px;width:100%;max-width:900px;
  padding:1rem;overflow:auto
}
.config-item{
  display:flex;gap:.5rem;align-items:center;
  background:#ffffff12;border:1px solid #ffffff22;
  border-radius:6px;margin-bottom:.6rem;
  padding:.5rem .75rem;direction:ltr;word-break:break-all
}
.config-text{flex:1;font-size:.85rem;line-height:1.4}
.copy-btn{
  padding:.4rem .8rem;border:none;border-radius:4px;
  background:#00c9ff;color:#04252e;font-size:.8rem;font-weight:700;
  cursor:pointer;transition:filter .2s
}
.copy-btn:hover{filter:brightness(1.1)}

footer{margin-top:1.5rem;font-size:.75rem;opacity:.7;text-align:center}

@media(max-width:480px){
  .logo{width:195px}
  .config-text{font-size:.78rem}
  .copy-btn{padding:.3rem .6rem;font-size:.75rem}
}

/* اضافه کردن به قسمت style */
.btn-action{
  font-size: .42rem;            /* 35% کوچک‌تر از .65rem */
  padding: .29rem .58rem;       /* 35% کوچک‌تر از .45rem .9rem */
  background:linear-gradient(90deg,#00c9ff 0%,#92fe9d 100%);
  color:#04252e;
  border:none;border-radius:8px;
  font-weight:700;text-decoration:none;
  cursor:pointer;transition:filter .2s;
  margin:.3rem;
}
.btn-action:hover{filter:brightness(1.08)}
.btn-action:disabled{opacity:.6;cursor:not-allowed}

.ping-display{
  font-size:.7rem;
  color:#92fe9d;
  margin-right:.5rem;
  min-width:35px;
  display:inline-block;
}
</style>

<body>

<header>
  <!-- لوگو -->
  <img src="iran_azad_logo.gif.png" alt="IRAN AZAD logo" class="logo">

  <!-- گروه دکمه‌های دانلود -->
  <div class="btn-group">
    <a class="btn-download" href="https://v2rayn.2dust.link/v2rayN-windows-64-SelfContained.zip" target="_blank" rel="noopener">دانلود ویندوز</a>
    <a class="btn-download" href="https://v2rayng.2dust.link/v2rayNG_1.10.4_arm64-v8a.apk" target="_blank" rel="noopener">دانلود اندروید</a>
    <a class="btn-download" href="https://apps.apple.com/ca/app/shadowrocket/id932747118" target="_blank" rel="noopener noreferrer">دانلود آیفون</a>
  </div>

  <h1>جدیدترین کانفیگ‌های&nbsp;V2Ray</h1>
  <div id="datetime">در حال به‌روزرسانی…</div>
  <div id="last-update">در حال بررسی آخرین به‌روزرسانی…</div>
</header>

<div style="margin-bottom:1rem;text-align:center;">
  <button id="copy-all-btn" class="btn-action">کپی کل کانفیگ‌ها</button>
  <button id="test-speed-btn" class="btn-action">تست سرعت و مرتب‌سازی</button>
</div>

<div id="box"><div id="loading">در حال بارگیری…</div></div>

<footer> به‌روزرسانی توسط  <strong>© 2025 IRAN.AZAD </strong></footer>

<script>
/* ---------- بارگذاری کانفیگ‌ها ---------- */
let allConfigsText = ''; // ذخیره متن کل کانفیگ‌ها

// استخراج دامنه از کانفیگ
function extractDomain(config) {
  try {
    // برای VLESS و Trojan
    if (config.includes('vless://') || config.includes('trojan://')) {
      const match = config.match(/@([^:]+):/);
      return match ? match[1] : null;
    }
    // برای VMess
    if (config.includes('vmess://')) {
      const match = config.match(/@([^:]+):/);
      if (match) return match[1];
      
      // اگر Base64 باشد
      try {
        const decoded = atob(config.replace('vmess://', ''));
        const data = JSON.parse(decoded);
        return data.add || data.host;
      } catch (e) {
        return null;
      }
    }
    // جستجوی عمومی برای IP یا دامنه
    const domainMatch = config.match(/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|([a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
    return domainMatch ? domainMatch[0] : null;
  } catch (e) {
    return null;
  }
}

// تست پینگ با Image
function testPing(domain) {
  return new Promise((resolve) => {
    if (!domain) {
      resolve(9999);
      return;
    }
    
    const img = new Image();
    const startTime = Date.now();
    const timeout = setTimeout(() => {
      resolve(9999);
    }, 5000);
    
    img.onload = img.onerror = () => {
      clearTimeout(timeout);
      const ping = Date.now() - startTime;
      resolve(ping);
    };
    
    img.src = `https://${domain}/favicon.ico?t=${Date.now()}`;
  });
}

// کپی کل کانفیگ‌ها
function copyAllConfigs() {
  const btn = document.getElementById('copy-all-btn');
  if (!allConfigsText) {
    btn.textContent = 'هیچ کانفیگی یافت نشد!';
    setTimeout(() => btn.textContent = 'کپی کل کانفیگ‌ها', 1500);
    return;
  }
  
  navigator.clipboard.writeText(allConfigsText).then(() => {
    const prevText = btn.textContent;
    btn.textContent = 'تمام کانفیگ‌ها کپی شد!';
    setTimeout(() => btn.textContent = prevText, 1500);
  }).catch(() => {
    btn.textContent = 'خطا در کپی!';
    setTimeout(() => btn.textContent = 'کپی کل کانفیگ‌ها', 1500);
  });
}

// تست سرعت و مرتب‌سازی
async function testSpeedAndSort() {
  const btn = document.getElementById('test-speed-btn');
  const configItems = document.querySelectorAll('.config-item');
  
  if (configItems.length === 0) return;
  
  btn.disabled = true;
  btn.textContent = 'در حال تست...';
  
  const results = [];
  
  // تست همه کانفیگ‌ها
  for (let i = 0; i < configItems.length; i++) {
    const item = configItems[i];
    const configText = item.querySelector('.config-text').textContent;
    const domain = extractDomain(configText);
    
    // نمایش وضعیت
    let pingSpan = item.querySelector('.ping-display');
    if (!pingSpan) {
      pingSpan = document.createElement('span');
      pingSpan.className = 'ping-display';
      item.insertBefore(pingSpan, item.querySelector('.copy-btn'));
    }
    
    pingSpan.textContent = '...';
    
    const ping = await testPing(domain);
    const displayPing = ping >= 9999 ? '∞' : `${ping}ms`;
    pingSpan.textContent = displayPing;
    
    results.push({
      element: item,
      ping: ping,
      config: configText
    });
    
    // تاخیر کوچک برای جلوگیری از فشار به شبکه
    if (i < configItems.length - 1) {
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  }
  
  // مرتب‌سازی بر اساس پینگ
  results.sort((a, b) => a.ping - b.ping);
  
  // مرتب‌سازی مجدد در DOM
  const box = document.getElementById('box');
  box.innerHTML = '';
  results.forEach(result => {
    box.appendChild(result.element);
  });
  
  btn.disabled = false;
  btn.textContent = 'تست سرعت و مرتب‌سازی';
}

/* ---------- بررسی آخرین به‌روزرسانی ---------- */
function checkLastUpdate(){
  fetch('configs.txt', {method: 'HEAD'})
    .then(response => {
      const lastModified = response.headers.get('Last-Modified');
      if(lastModified){
        const fileDate = new Date(lastModified);
        const now = new Date();
        const diffMs = now - fileDate;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffHours / 24);
        
        let updateText = '';
        if(diffDays > 0){
          updateText = `به‌روزرسانی شده ${diffDays} روز قبل`;
        } else if(diffHours > 0){
          updateText = `به‌روزرسانی شده ${diffHours} ساعت قبل`;
        } else {
          const diffMinutes = Math.floor(diffMs / (1000 * 60));
          if(diffMinutes > 0){
            updateText = `به‌روزرسانی شده ${diffMinutes} دقیقه قبل`;
          } else {
            updateText = 'به‌روزرسانی شده همین الان';
          }
        }
        
        document.getElementById('last-update').textContent = updateText;
      } else {
        document.getElementById('last-update').textContent = 'زمان به‌روزرسانی نامشخص';
      }
    })
    .catch(() => {
      document.getElementById('last-update').textContent = 'خطا در بررسی زمان به‌روزرسانی';
    });
}

/* ---------- تاریخ و ساعت شمسی ---------- */
function updateDateTime(){
  const now=new Date();
  const opts={calendar:'persian',numberingSystem:'latn',
              hour:'2-digit',minute:'2-digit',second:'2-digit',
              weekday:'long',year:'numeric',month:'long',day:'numeric',
              timeZone:'Asia/Tehran'};
  document.getElementById('datetime').textContent=
    new Intl.DateTimeFormat('fa-IR-u-ca-persian',opts).format(now);
}
updateDateTime(); setInterval(updateDateTime,30000);
</script>

</body>
</html>
